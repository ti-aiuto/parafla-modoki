<!DOCTYPE html>
<html>
  <head>
    <script src="compiler.js" type="text/javascript"></script>
    <script src="render.js" type="text/javascript"></script>
    <script src="inputtextsample.js" type="text/javascript"></script>
    <script type="text/javascript">
      const range = (start, end) => [...Array(end + 1).keys()].slice(start);

      function main() {
        const frameEvents = window.frameEvents;
        const scheduleFrameEvents = window.scheduleFrameEvents;

        const render = window.render;
        const calcualteLabelFrameCount = window.calcualteLabelFrameCount;

        const rootInstanceId = "rootDummyHoge";
        const context = (function () {
          const instance = {
            play() {
              controller.play();
            },
            stop() {
              controller.stop();
            },
            gotoAndPlay(destination) {
              controller.gotoAndPlay(destination);
            },
            eraseLayers(depths) {
              controller.eraseLayers(depths);
            },
            setUserVariable(key, value) {
              controller.setUserVariable(key, value);
            },
            getUserVariable(key) {
              return controller.getUserVariable(key);
            },
            findTextObjectById(id) {
              const fullObjectId = rootInstanceId + "_" + id;
              const element = document.querySelector(
                `[data-object-id="${fullObjectId}"]`
              );
              if (!element) {
                return null;
              }
              return {
                getValue() {
                  return element.value;
                },
                setValue(value) {
                  element.value = value;
                },
              };
            },
          };
          return instance;
        })();

        const controller = (function () {
          const instance = {};

          instance.load = function (frameEvents) {
            instance.labelToFrameCount = calcualteLabelFrameCount(frameEvents);
            instance.currentFrameCount = 1;
            instance.jumpToFrameCount = null;
            // 表示データ
            instance.depthToLayer = {};

            instance.absoluteFrameCountToScheduledFrameEvents =
              scheduleFrameEvents(frameEvents);

            // 最後まで達したら最初に戻るため
            instance.lastFrameCount = Math.max.apply(
              null,
              Object.keys(instance.absoluteFrameCountToScheduledFrameEvents)
            );

            instance.userVariables = {};
          };

          instance.play = function () {
            instance.timerId = setInterval(this.tick, 100);
          };
          instance.stop = function () {
            clearInterval(instance.timerId);
          };
          instance.eraseLayers = function (depths) {
            if (depths.includes("all")) {
              Object.keys(instance.depthToLayer).forEach(function (eachDepth) {
                instance.depthToLayer[eachDepth] = undefined;
              });
            } else {
              depths.forEach(function (eachDepth) {
                instance.depthToLayer[eachDepth] = undefined;
              });
            }
          };
          instance.gotoAndPlay = function (destination) {
            // TODO: 本当はここでバリデーションが必要
            if (typeof destination === "string") {
              instance.jumpToFrameCount = Number(
                instance.labelToFrameCount[destination]
              );
            } else {
              instance.jumpToFrameCount = destination;
            }
            instance.play();
          };
          instance.setUserVariable = function (key, value) {
            instance.userVariables[key] = JSON.stringify(value);
            console.log("ユーザ変数設定", key, instance.userVariables[key]);
          };
          instance.getUserVariable = function (key) {
            console.log("ユーザ変数取得", key, instance.userVariables[key]);
            if (instance.userVariables[key] !== undefined) {
              return JSON.parse(instance.userVariables[key]);
            } else {
              return undefined;
            }
          };

          instance.handleAction = function (action) {
            // stop, gotoAndPlayはframeCountが1になる
            // defineLabel, eraseLayersはframeCountは0
            if (action.type === "eraseLayers") {
              context.eraseLayers(action.eraseLayers.depths);
            } else if (action.type === "stop") {
              context.stop();
            } else if (action.type === "play") {
              context.play();
            } else if (action.type === "gotoAndPlay") {
              context.gotoAndPlay(action.gotoAndPlay.destination);
            } else if (action.type === "executeScript") {
              const func = new Function(
                "context",
                action.executeScript.content
              );
              func(context);
            }
          };

          instance.tick = function () {
            // 最後まで行ったら最初に戻る（判定これでいいのかな？）
            if (instance.currentFrameCount > instance.lastFrameCount) {
              instance.currentFrameCount = 1;
            }

            // 飛び先が指定されていたらそっちにいく
            if (instance.jumpToFrameCount !== null) {
              instance.currentFrameCount = instance.jumpToFrameCount;
              instance.jumpToFrameCount = null;
            }

            // console.log(instance.currentFrameCount);

            const currentScheduledFrameEvents =
              instance.absoluteFrameCountToScheduledFrameEvents[
                instance.currentFrameCount
              ] || [];

            currentScheduledFrameEvents.forEach(function (scheduledFrameEvent) {
              const event = scheduledFrameEvent.event;
              const depth = event.depth;

              if (event.type === "executeAction") {
                console.log("executeAction", event.executeAction);
                instance.handleAction(event.executeAction);
              }

              if (event.type === "putImage" || event.type === "putText") {
                let objectBase = null;
                // ここの種別は、画像・テキスト・HTML要素・音声・スプライトなどを想定
                if (event.type === "putImage") {
                  objectBase = {
                    type: "image",
                    image: {
                      source: event.putImage.source,
                    },
                    onClickAction: event.onClickAction,
                    objectId: scheduledFrameEvent.objectId,
                  };
                } else if (event.type === "putText") {
                  objectBase = {
                    type: "text",
                    text: {
                      ...event.putText,
                    },
                    onClickAction: event.onClickAction,
                    objectId: scheduledFrameEvent.objectId,
                  };
                }

                if (scheduledFrameEvent.frameCountInEvent <= 1) {
                  // 0または1
                  // TODO: ここでdepthあるかの判定
                  instance.depthToLayer[depth] = {
                    object: {
                      ...objectBase,
                      useCache: false,
                      layoutOptions: event.layoutOptions,
                    },
                  };
                } else {
                  const before = event.layoutOptions;
                  const after = event.lastKeyFrame.layoutOptions;

                  // TODO: ここでdepthあるかの判定
                  instance.depthToLayer[depth] = {
                    object: {
                      ...objectBase,
                      useCache: true,
                      layoutOptions: {
                        x:
                          before.x +
                          (scheduledFrameEvent.frameCountInEvent *
                            (after.x - before.x)) /
                            event.frameCount,
                        y:
                          before.y +
                          (scheduledFrameEvent.frameCountInEvent *
                            (after.y - before.y)) /
                            event.frameCount,
                        width:
                          before.width +
                          (scheduledFrameEvent.frameCountInEvent *
                            (after.width - before.width)) /
                            event.frameCount,
                        height:
                          before.height +
                          (scheduledFrameEvent.frameCountInEvent *
                            (after.height - before.height)) /
                            event.frameCount,
                      },
                    },
                  };
                }
              }

              render(instance.depthToLayer, { handleAction: instance.handleAction, rootInstanceId });
            });
            instance.currentFrameCount += 1;
          };

          return instance;
        })();
        controller.load(frameEvents);
        controller.play();
      }

      window.onload = function () {
        main();
      };
    </script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
