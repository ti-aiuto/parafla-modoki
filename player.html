<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript">
      function main() {
        const frameEvents = [
          {
            type: "putImage",
            putImage: {
              type: "fixedImage",
              source:
                "https://blog.ta.kasaki.info/wp-content/uploads/2022/06/IMG_20220522_182837929-1152x1536.jpg",
            },
            depth: 1,
            frameCount: 1,
            layoutOptions: {
              x: 0,
              y: 0,
              width: 120,
              height: 120,
            },
          },
          {
            type: "doNothing",
            frameCount: 9,
          },
          {
            type: "putImage",
            putImage: {
              source:
                "https://blog.ta.kasaki.info/wp-content/uploads/2022/06/IMG_20220524_122351263-1536x1152.jpg",
              type: "fixedImage",
            },
            depth: 1,
            frameCount: 1,
            layoutOptions: {
              x: 20,
              y: 20,
              width: 120,
              height: 120,
            },
          },
          {
            type: "doNothing",
            frameCount: 9,
          },
          {
            type: "putImage",
            putImage: {
              source:
                "https://blog.ta.kasaki.info/wp-content/uploads/2021/06/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88-2021-06-03-14.28.33.png",
              type: "fixedImage",
            },
            depth: 1,
            frameCount: 1,
            layoutOptions: {
              x: 40,
              y: 40,
              width: 120,
              height: 120,
            },
          },
          {
            type: "doNothing",
            frameCount: 9,
          },
          {
            type: "putImage",
            putImage: {
              type: "motionTweenImage",
              source:
                "https://blog.ta.kasaki.info/wp-content/uploads/2022/06/IMG_20220522_182837929-1152x1536.jpg",
            },
            depth: 1,
            frameCount: 5,
            layoutOptions: {
              x: 0,
              y: 0,
              width: 120,
              height: 120,
            },
            lastKeyFrame: {
              layoutOptions: {
                x: 50,
                y: 50,
                width: 120,
                height: 120,
              },
            },
          },
        ];

        const absoluteFrameCountToScheduledFrameEvents = {
          1: [
            {
              event: frameEvents[0],
              relativeFrameCountInEvent: 1,
              objectId: "randomA",
            },
          ],
          11: [
            {
              event: frameEvents[2],
              relativeFrameCountInEvent: 1,
              objectId: "randomB",
            },
          ],
          21: [
            {
              event: frameEvents[4],
              relativeFrameCountInEvent: 1,
              objectId: "randomC",
            },
          ],
          31: [
            {
              event: frameEvents[6],
              relativeFrameCountInEvent: 1,
              objectId: "randomC",
            },
          ],
          32: [
            {
              event: frameEvents[6],
              relativeFrameCountInEvent: 2,
              objectId: "randomC",
            },
          ],
          33: [
            {
              event: frameEvents[6],
              relativeFrameCountInEvent: 3,
              objectId: "randomC",
            },
          ],
          34: [
            {
              event: frameEvents[6],
              relativeFrameCountInEvent: 4,
              objectId: "randomC",
            },
          ],
          35: [
            {
              event: frameEvents[6],
              relativeFrameCountInEvent: 5,
              objectId: "randomC",
            },
          ],
        };

        const depthToLayerWrapper = {};
        const objectIdToElement = {}; // TODO: 要素のキャッシュを実装する
        function render(depthToLayer) {
          const root = document.getElementById("root");
          // TODO: 列挙順
          Object.keys(depthToLayer).forEach(function (depth) {
            const layer = depthToLayer[depth];
            const object = layer.object;
            console.log(object);
            if (!object) {
              return;
            }

            if (!depthToLayerWrapper[depth]) {
              const newWrapper = document.createElement("div");
              // TODO: ここでposition: absolute, zindex, width, height設定
              root.appendChild(newWrapper);
              depthToLayerWrapper[depth] = newWrapper;
            }
            const wrapper = depthToLayerWrapper[depth];
            while (wrapper.firstChild) {
              wrapper.removeChild(wrapper.firstChild);
            }

            if (object.type === "image") {
              const imageElement = document.createElement("img");
              imageElement.src = object.image.source;
              wrapper.appendChild(imageElement);
              const layoutOptions = object.layoutOptions;
              console.log(layoutOptions);
              imageElement.style.position = "absolute";
              imageElement.style.width = `${layoutOptions.width}px`;
              imageElement.style.height = `${layoutOptions.height}px`;
              imageElement.style.left = `${layoutOptions.x}px`;
              imageElement.style.top = `${layoutOptions.y}px`;
            }
          });
        }

        const depthToLayer = {};
        let currentFrameCount = 0;
        setInterval(function () {
          currentFrameCount += 1;
          const currentScheduledFrameEvents =
            absoluteFrameCountToScheduledFrameEvents[currentFrameCount];
          if (!currentScheduledFrameEvents) {
            // 何もしないフレーム
            return;
          }

          currentScheduledFrameEvents.forEach(function (scheduledFrameEvent) {
            if (scheduledFrameEvent.relativeFrameCountInEvent === 1) {
              const event = scheduledFrameEvent.event;
              const depth = event.depth;
              // TODO: ここでdepthあるかの判定
              // TODO: ここでtypeの判定
              depthToLayer[depth] = {
                object: {
                  // ここの種別は、画像・テキスト・HTML要素・音声・スプライトなどを想定
                  type: "image",
                  image: {
                    source: event.putImage.source,
                  },
                  layoutOptions: event.layoutOptions,
                },
              };
            } else {
              const event = scheduledFrameEvent.event;
              const depth = event.depth;

              const before = event.layoutOptions;
              const after = event.lastKeyFrame.layoutOptions;

              // TODO: ここでdepthあるかの判定
              // TODO: ここでtypeの判定
              depthToLayer[depth] = {
                object: {
                  // ここの種別は、画像・テキスト・HTML要素・音声・スプライトなどを想定
                  type: "image",
                  image: {
                    source: event.putImage.source,
                  },
                  layoutOptions: {
                    x: before.x + scheduledFrameEvent.relativeFrameCountInEvent * (after.x - before.x) / event.frameCount, 
                    y: before.y + scheduledFrameEvent.relativeFrameCountInEvent * (after.y - before.y) / event.frameCount,
                    width: before.width + scheduledFrameEvent.relativeFrameCountInEvent * (after.width - before.width) / event.frameCount, 
                    height: before.height + scheduledFrameEvent.relativeFrameCountInEvent * (after.height - before.height) / event.frameCount,
                  }
                },
              };
             
            }

            render(depthToLayer);
          });
        }, 100);
      }

      window.onload = function () {
        main();
      };
    </script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
