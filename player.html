<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript">
      const range = (start, end) => [...Array(end + 1).keys()].slice(start);

      function main() {
        const frameEvents = [
          {
            type: "putImage",
            putImage: {
              source:
                "https://blog.ta.kasaki.info/wp-content/uploads/2022/06/IMG_20220522_182837929-1152x1536.jpg",
            },
            depth: 1,
            frameCount: 1,
            layoutOptions: {
              x: 0,
              y: 0,
              width: 120,
              height: 120,
            },
            motionTweenEnabled: true,
          },
          {
            type: "doNothing",
            frameCount: 9,
          },
          {
            type: "putImage",
            putImage: {
              source:
                "https://blog.ta.kasaki.info/wp-content/uploads/2022/06/IMG_20220524_122351263-1536x1152.jpg",
            },
            depth: 1,
            frameCount: 1,
            layoutOptions: {
              x: 20,
              y: 20,
              width: 120,
              height: 120,
            },
            motionTweenEnabled: true,
          },
          {
            type: "doNothing",
            frameCount: 9,
          },
          {
            type: "putImage",
            putImage: {
              source:
                "https://blog.ta.kasaki.info/wp-content/uploads/2021/06/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88-2021-06-03-14.28.33.png",
            },
            depth: 1,
            frameCount: 1,
            layoutOptions: {
              x: 40,
              y: 40,
              width: 120,
              height: 120,
            },
            motionTweenEnabled: true,
          },
          {
            type: "doNothing",
            frameCount: 9,
          },
          {
            type: "putImage",
            putImage: {
              source:
                "https://blog.ta.kasaki.info/wp-content/uploads/2022/06/IMG_20220522_182837929-1152x1536.jpg",
            },
            depth: 1,
            frameCount: 5,
            layoutOptions: {
              x: 0,
              y: 0,
              width: 120,
              height: 120,
            },
            lastKeyFrame: {
              layoutOptions: {
                x: 50,
                y: 50,
                width: 120,
                height: 120,
              },
            },
            motionTweenEnabled: true,
          },
        ];

        function scheduleFrameEvents(frameEvents) {
          const absoluteFrameCountToScheduledFrameEvents = {};
          let currentFrameCount = 1;
          frameEvents.forEach(function (frameEvent) {
            const objectId = "dummy";
            range(0, frameEvent.frameCount - 1).forEach(function (
              frameCountInEvent,
              index
            ) {
              const fixedFrameCountInEvent = currentFrameCount + index;
              if (
                !absoluteFrameCountToScheduledFrameEvents[
                  fixedFrameCountInEvent
                ]
              ) {
                absoluteFrameCountToScheduledFrameEvents[
                  fixedFrameCountInEvent
                ] = [];
              }
              if (frameEvent.type !== "doNothing") {
                absoluteFrameCountToScheduledFrameEvents[
                  fixedFrameCountInEvent
                ].push({
                  event: frameEvent,
                  frameCountInEvent: index + 1,
                  objectId: objectId,
                });
              }
            });
            currentFrameCount += frameEvent.frameCount;
          });
          return absoluteFrameCountToScheduledFrameEvents;
        }

        const absoluteFrameCountToScheduledFrameEvents = scheduleFrameEvents(frameEvents);

        const depthToLayerWrapper = {};
        const objectIdToElement = {}; // TODO: 要素のキャッシュを実装する
        function render(depthToLayer) {
          const root = document.getElementById("root");
          // TODO: 列挙順
          Object.keys(depthToLayer).forEach(function (depth) {
            const layer = depthToLayer[depth];
            const object = layer.object;
            console.log(object);
            if (!object) {
              return;
            }

            if (!depthToLayerWrapper[depth]) {
              const newWrapper = document.createElement("div");
              // TODO: ここでposition: absolute, zindex, width, height設定
              root.appendChild(newWrapper);
              depthToLayerWrapper[depth] = newWrapper;
            }
            const wrapper = depthToLayerWrapper[depth];
            while (wrapper.firstChild) {
              wrapper.removeChild(wrapper.firstChild);
            }

            if (object.type === "image") {
              const imageElement = document.createElement("img");
              imageElement.src = object.image.source;
              wrapper.appendChild(imageElement);
              const layoutOptions = object.layoutOptions;
              console.log(layoutOptions);
              imageElement.style.position = "absolute";
              imageElement.style.width = `${layoutOptions.width}px`;
              imageElement.style.height = `${layoutOptions.height}px`;
              imageElement.style.left = `${layoutOptions.x}px`;
              imageElement.style.top = `${layoutOptions.y}px`;
            }
          });
        }

        const depthToLayer = {};
        let currentFrameCount = 0;
        setInterval(function () {
          currentFrameCount += 1;
          const currentScheduledFrameEvents =
            absoluteFrameCountToScheduledFrameEvents[currentFrameCount];
          if (!currentScheduledFrameEvents) {
            // 何もしないフレーム
            return;
          }

          currentScheduledFrameEvents.forEach(function (scheduledFrameEvent) {
            if (scheduledFrameEvent.frameCountInEvent === 1) {
              const event = scheduledFrameEvent.event;
              const depth = event.depth;
              // TODO: ここでdepthあるかの判定
              // TODO: ここでtypeの判定
              depthToLayer[depth] = {
                object: {
                  // ここの種別は、画像・テキスト・HTML要素・音声・スプライトなどを想定
                  type: "image",
                  image: {
                    source: event.putImage.source,
                  },
                  layoutOptions: event.layoutOptions,
                },
              };
            } else {
              const event = scheduledFrameEvent.event;
              const depth = event.depth;

              const before = event.layoutOptions;
              const after = event.lastKeyFrame.layoutOptions;

              // TODO: ここでdepthあるかの判定
              // TODO: ここでtypeの判定
              depthToLayer[depth] = {
                object: {
                  // ここの種別は、画像・テキスト・HTML要素・音声・スプライトなどを想定
                  type: "image",
                  image: {
                    source: event.putImage.source,
                  },
                  layoutOptions: {
                    x:
                      before.x +
                      (scheduledFrameEvent.frameCountInEvent *
                        (after.x - before.x)) /
                        event.frameCount,
                    y:
                      before.y +
                      (scheduledFrameEvent.frameCountInEvent *
                        (after.y - before.y)) /
                        event.frameCount,
                    width:
                      before.width +
                      (scheduledFrameEvent.frameCountInEvent *
                        (after.width - before.width)) /
                        event.frameCount,
                    height:
                      before.height +
                      (scheduledFrameEvent.frameCountInEvent *
                        (after.height - before.height)) /
                        event.frameCount,
                  },
                },
              };
            }

            render(depthToLayer);
          });
        }, 100);
      }

      window.onload = function () {
        main();
      };
    </script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
