<!DOCTYPE html>
<html>
  <head>
    <script
      type="text/javascript"
      src="../prototype/samples/slideshowloop.js"
    ></script>
    <script type="text/javascript" src="assets.js"></script>
    <script type="text/javascript">
      window.onload = function () {
        const AssetsManager = function () {
          const instance = {};

          instance.find = function (id) {
            return window.dummyAssets[id];
          };

          return instance;
        };

        const RootController = function () {
          const instance = {};

          instance.registerClickEvent = function () {};
          instance.unregisterClickEvent = function () {};

          instance.registerHoverEvent = function () {};
          instance.unregisterHoverEvent = function () {};

          instance.registerMousedownEvent = function () {};
          instance.unregisterMousedownEvent = function () {};

          instance.registerTimer = function () {};
          instance.unregisterTimer = function () {};

          instance.defineUserVariable = function () {};
          instance.setUserVariable = function () {};
          instance.getUserVariable = function () {};

          return instance;
        };

        const ComponentSource = function (scheduledEvents, labelToFrameNumber) {
          const instance = {};

          instance.scheduledEvents = scheduledEvents;
          instance.labelToFrameNumber = labelToFrameNumber;

          return instance;
        };

        const ScreenObjectsManager = function () {
          const instance = {};
          instance.depthToLayer = {};
          return instance;
        };

        const Compiler = function () {
          const instance = {};
          const range = (start, end) => [...Array(end + 1).keys()].slice(start);

          instance.formetFrameEvents = function (frameEvents) {
            // データ整形
            frameEvents.forEach(function (frameEvent) {
              if (["defineLabel"].includes(frameEvent.type)) {
                frameEvent.frameCount = 0;
              }
              if (["executeAction"].includes(frameEvent.type)) {
                if (
                  ["stop", "gotoAndPlay"].includes(
                    frameEvent.executeAction.type
                  )
                ) {
                  frameEvent.frameCount = 1;
                } else {
                  frameEvent.frameCount = 0;
                }
              }
            });
          };

          instance.generateScheduledEvents = function (frameEvents) {
            const absoluteFrameCountToScheduledFrameEvents = {};
            let currentFrameCount = 1;

            frameEvents.forEach(function (frameEvent) {
              const objectId = frameEvent.objectId
                ? frameEvent.objectId
                : "auto" + Math.random(); // 値が未指定の場合もframeEvent内で一律で持てるとよい

              // この分岐はなくても動くが無駄なオブジェクトが生成されるのを避けたい
              if (frameEvent.type !== "defineLabel") {
                if (frameEvent.frameCount === 0) {
                  if (
                    !absoluteFrameCountToScheduledFrameEvents[currentFrameCount]
                  ) {
                    absoluteFrameCountToScheduledFrameEvents[
                      currentFrameCount
                    ] = [];
                  }

                  absoluteFrameCountToScheduledFrameEvents[
                    currentFrameCount
                  ].push({
                    event: frameEvent,
                    frameCountInEvent: 0, // 便宜上0にしておく
                    objectId: objectId,
                  });
                } else {
                  range(0, frameEvent.frameCount - 1).forEach(function (
                    frameCountInEvent
                  ) {
                    if (
                      frameEvent.type === "doNothing" &&
                      frameCountInEvent !== frameEvent.frameCount - 1
                    ) {
                      // 最後の1フレーム以外は追加しない
                      return;
                    }

                    const fixedFrameCountInEvent =
                      currentFrameCount + frameCountInEvent;
                    if (
                      !absoluteFrameCountToScheduledFrameEvents[
                        fixedFrameCountInEvent
                      ]
                    ) {
                      absoluteFrameCountToScheduledFrameEvents[
                        fixedFrameCountInEvent
                      ] = [];
                    }
                    absoluteFrameCountToScheduledFrameEvents[
                      fixedFrameCountInEvent
                    ].push({
                      event: frameEvent,
                      frameCountInEvent: frameCountInEvent + 1,
                      objectId: objectId,
                    });
                  });
                }
              }

              currentFrameCount += frameEvent.frameCount;
            });
            return absoluteFrameCountToScheduledFrameEvents;
          };

          instance.generateLabelToFrameNumber = function (frameEvents) {
            const labelToFrameCount = {};
            let currentFrameCount = 1;
            frameEvents.forEach(function (frameEvent) {
              if (frameEvent.type === "defineLabel") {
                const label = frameEvent.defineLabel.label;
                labelToFrameCount[label] = currentFrameCount;
              }

              currentFrameCount += frameEvent.frameCount;
            });
            return labelToFrameCount;
          };

          instance.compile = function (frameEvents) {
            instance.formetFrameEvents(frameEvents);

            const componentSource = ComponentSource(
              instance.generateScheduledEvents(frameEvents),
              instance.generateLabelToFrameNumber(frameEvents)
            );
            return componentSource;
          };

          return instance;
        };

        const Component = function (
          rootController,
          componentSource,
          screenObjectsManager,
          renderer
        ) {
          const instance = {};

          instance.rootController = rootController;
          instance.componentSource = componentSource;
          instance.screenObjectsManager = screenObjectsManager;
          instance.currentFrameCount = 1;
          instance.jumpToFrameCount = null;
          instance.lastFrameCount = Math.max.apply(
            null,
            Object.keys(instance.componentSource.scheduledEvents)
          );
          instance.rootInstanceId = "rootDummyHoge";
          instance.renderer = renderer;

          instance.findAssetById = function (id) {
            return assetsManager.find(id);
          };

          instance.play = function () {
            instance.stop();
            instance.timerId = setInterval(this.tick, 50);
          };
          instance.stop = function () {
            clearInterval(instance.timerId);
          };

          instance.generateFullObjectId = function (objectId) {
            return `${instance.rootInstanceId}_${objectId}`;
          };

          // instance.eraseLayers = function (depths) {
          //   if (depths.includes("all")) {
          //     Object.keys(instance.depthToLayer).forEach(function (eachDepth) {
          //       instance.depthToLayer[eachDepth] = undefined;
          //     });
          //   } else {
          //     depths.forEach(function (eachDepth) {
          //       instance.depthToLayer[eachDepth] = undefined;
          //     });
          //   }
          // };
          // instance.gotoAndPlay = function (destination) {
          //   // TODO: 本当はここでバリデーションが必要
          //   if (typeof destination === "string") {
          //     const label = instance.labelToFrameCount[destination];
          //     console.log("ラベル解決", destination, label);
          //     instance.jumpToFrameCount = Number(label);
          //   } else {
          //     instance.jumpToFrameCount = destination;
          //   }
          //   instance.play();
          // };

          instance.handleAction = function (action) {
            const context = {
              play() {
                controller.play();
              },
              stop() {
                controller.stop();
              },
              gotoAndPlay(destination) {
                controller.gotoAndPlay(destination);
              },
              eraseLayers(depths) {
                controller.eraseLayers(depths);
              },
              setUserVariable(key, value, updateBinding = true) {
                controller.setUserVariable(key, value);
              },
              getUserVariable(key, defaultValue) {
                return controller.getUserVariable(key, defaultValue);
              },
              setTextValue(objectId, value) {
                controller.setTextValue(objectId, value);
              },
              getTextValue(objectId) {
                return controller.getTextValue(objectId);
              },
            };

            // stop, gotoAndPlayはframeCountが1になる
            // defineLabel, eraseLayersはframeCountは0
            if (action.type === "eraseLayers") {
              context.eraseLayers(action.eraseLayers.depths);
            } else if (action.type === "stop") {
              context.stop();
            } else if (action.type === "play") {
              context.play();
            } else if (action.type === "gotoAndPlay") {
              context.gotoAndPlay(action.gotoAndPlay.destination);
            } else if (action.type === "executeScript") {
              const func = new Function(
                "context",
                action.executeScript.content
              );
              func(context);
            }
          };

          // instance.setTextValue = function (objectId, value) {
          //   for ({ object } of Object.values(instance.depthToLayer)) {
          //     if (!object) {
          //       continue;
          //     }
          //     if (
          //       object.fullObjectId === instance.generateFullObjectId(objectId)
          //     ) {
          //       object.text.content = value;
          //       break;
          //     }
          //   }
          //   instance.render();
          // };

          // instance.getTextValue = function (objectId) {
          //   for ({ object } of Object.values(instance.depthToLayer)) {
          //     if (!object) {
          //       continue;
          //     }
          //     if (
          //       object.fullObjectId === instance.generateFullObjectId(objectId)
          //     ) {
          //       return object.text.content;
          //     }
          //   }
          //   return undefined;
          // };

          instance.render = function () {
            instance.renderer.render(instance.screenObjectsManager);
          };

          instance.tick = function () {
            // 最後まで行ったら最初に戻る（判定これでいいのかな？）
            if (instance.currentFrameCount > instance.lastFrameCount) {
              instance.currentFrameCount = 1;
            }

            // 飛び先が指定されていたらそっちにいく
            if (instance.jumpToFrameCount !== null) {
              instance.currentFrameCount = instance.jumpToFrameCount;
              instance.jumpToFrameCount = null;
            }

            const currentScheduledFrameEvents =
              instance.componentSource.scheduledEvents[
                instance.currentFrameCount
              ] || [];

            currentScheduledFrameEvents.forEach(function (scheduledFrameEvent) {
              if (instance.jumpToFrameCount !== null) {
                return; // frameCount>1のイベントよりも前にgotoAndPlayを実行していた場合は先に飛ぶ
              }

              const event = scheduledFrameEvent.event;
              const depth = event.depth;

              if (event.type === "putImage" || event.type === "putText") {
                let objectBase = null;
                // ここの種別は、画像・テキスト・HTML要素・音声・スプライトなどを想定
                if (event.type === "putImage") {
                  objectBase = {
                    type: "image",
                    image: structuredClone(
                      instance.findAssetById(event.putImage.resourceId)["image"]
                    ),
                    onClickAction: event.onClickAction,
                    fullObjectId: instance.generateFullObjectId(
                      scheduledFrameEvent.objectId
                    ),
                    rendered: false,
                  };
                } else if (event.type === "putText") {
                  objectBase = {
                    type: "text",
                    text: structuredClone(
                      instance.findAssetById(event.putText.resourceId)["text"]
                    ),
                    onClickAction: event.onClickAction,
                    fullObjectId: instance.generateFullObjectId(
                      scheduledFrameEvent.objectId
                    ),
                  };
                }

                if (scheduledFrameEvent.frameCountInEvent <= 1) {
                  // 0または1
                  // TODO: ここでdepthあるかの判定
                  instance.screenObjectsManager.depthToLayer[depth] = {
                    object: {
                      ...objectBase,
                      layoutOptions: event.layoutOptions,
                    },
                  };
                } else {
                  const before = event.layoutOptions;
                  const after = event.lastKeyFrame.layoutOptions;

                  // TODO: ここでdepthあるかの判定
                  instance.screenObjectsManager.depthToLayer[depth] = {
                    object: {
                      ...objectBase,
                      layoutOptions: {
                        x:
                          before.x +
                          (scheduledFrameEvent.frameCountInEvent *
                            (after.x - before.x)) /
                            event.frameCount,
                        y:
                          before.y +
                          (scheduledFrameEvent.frameCountInEvent *
                            (after.y - before.y)) /
                            event.frameCount,
                        width:
                          before.width +
                          (scheduledFrameEvent.frameCountInEvent *
                            (after.width - before.width)) /
                            event.frameCount,
                        height:
                          before.height +
                          (scheduledFrameEvent.frameCountInEvent *
                            (after.height - before.height)) /
                            event.frameCount,
                      },
                    },
                  };
                }
              }

              instance.render();
            });

            instance.currentFrameCount += 1;
          };

          return instance;
        };

        const Renderer = function () {
          const instance = {};

          const depthToLayerWrapper = {};

          function setLayoutOptionsToElement(element, layoutOptions) {
            element.style.position = "absolute";
            element.style.width = `${layoutOptions.width}px`;
            element.style.height = `${layoutOptions.height}px`;
            element.style.left = `${layoutOptions.x}px`;
            element.style.top = `${layoutOptions.y}px`;
          }

          // function setOnClickActionListener(element, action, handleAction) {
          //   if (!action) {
          //     return;
          //   }
          //   element.onclick = function () {
          //     console.log("click", element, action);
          //     handleAction(action);
          //   };
          // }

          instance.render = function render(screenObjectsManager) {
            const depthToLayer = screenObjectsManager.depthToLayer;
            const root = document.getElementById("root");

            // TODO: ここの設定値も外から持ってくる
            root.style.border = "solid 1px #000";
            root.style.width = "640px";
            root.style.height = "480px";
            root.style.position = "relative";
            root.style.overflow = "hidden";

            // TODO: 列挙順がdepth順になっていることを保証する
            Object.keys(depthToLayer).forEach(function (depth) {
              const layer = depthToLayer[depth];

              if (!depthToLayerWrapper[depth]) {
                const newWrapper = document.createElement("div");
                // TODO: ここでposition: absolute, zindex, width, height設定
                root.appendChild(newWrapper);
                depthToLayerWrapper[depth] = newWrapper;
              }

              const wrapper = depthToLayerWrapper[depth];
              const object = layer && layer.object;
              if (!object) {
                // 何もなくなってたら消すだけ
                if (wrapper.firstChild) {
                  wrapper.removeChild(wrapper.firstChild);
                }
                return;
              }

              let targetElement = null;
              const candidateElement = wrapper.firstChild;
              if (
                candidateElement &&
                candidateElement.dataset.fullObjectId === object.fullObjectId
              ) {
                targetElement = candidateElement;
              }

              if (!targetElement) {
                console.log("cache無し");
                if (wrapper.firstChild) {
                  wrapper.removeChild(wrapper.firstChild);
                }
                if (object.type === "image") {
                  targetElement = document.createElement("img");
                } else if (object.type === "text") {
                  if (object.text.editable) {
                    targetElement = document.createElement("input");
                    targetElement.addEventListener("input", function (event) {
                      object.text.content = event.target.value; // 中間データオブジェクトに同期しておく
                    });
                  } else {
                    targetElement = document.createElement("div");
                  }
                }
                targetElement.dataset.fullObjectId = object.fullObjectId;
                targetElement.style.zIndex = depth;
                wrapper.appendChild(targetElement);
                // setOnClickActionListener(
                //   targetElement,
                //   object.onClickAction,
                //   instance.handleAction
                // );
              }

              const layoutOptions = object.layoutOptions;
              setLayoutOptionsToElement(targetElement, layoutOptions);
              if (object.type === "image") {
                targetElement.src = object.image.source;
              } else if (object.type === "text") {
                if (object.text.editable) {
                  if (targetElement.value !== object.text.content) {
                    targetElement.value = object.text.content;
                  }
                } else {
                  if (targetElement.innerHTML !== object.text.content) {
                    targetElement.innerHTML = object.text.content; // XSS
                    object.text.content = targetElement.innerHTML; // ブラウザがinnerHTMLを補正する可能性がありそう
                  }
                }
                if (object.onClickAction) {
                  targetElement.style.cursor = "pointer";
                }
                // 全部デフォルト値を持った上で上書きしたほうがいい
                if (object.text.borderWidth) {
                  targetElement.style.borderWidth = `${object.text.borderWidth}px`;
                }
                if (object.text.borderStyle) {
                  targetElement.style.borderStyle = object.text.borderStyle;
                }
                if (object.text.borderColor) {
                  targetElement.style.borderColor = object.text.borderColor;
                }
                if (object.text.backgroundColor) {
                  targetElement.style.backgroundColor =
                    object.text.backgroundColor;
                }
              }
            });
          }

          return instance;
        };

        const assetsManager = AssetsManager();
        const compiler = Compiler();
        const renderer = Renderer();
        const rootController = RootController();
        const component = Component(
          rootController,
          compiler.compile(window.frameEventsSlideshowLoop),
          ScreenObjectsManager(),
          renderer
        );
        component.play();
      };
    </script>
    <style></style>
  </head>
  <body>
    <div id="frame_count">フレーム番号:</div>
    <div id="root" style="width: 640px; height: 480px"></div>
  </body>
</html>
