<!DOCTYPE html>
<html>
  <head>
    <title>プレビュー画面</title>

    <script type="text/javascript" src="root_controller.js"></script>
    <script type="text/javascript" src="screen_objects_manager.js"></script>
    <script type="text/javascript" src="compiler.js"></script>
    <script type="text/javascript" src="component.js"></script>
    <script type="text/javascript" src="object_builder.js"></script>
    <script type="text/javascript" src="renderer.js"></script>
    <script type="text/javascript" src="assets_manager.js"></script>

    <script type="text/javascript">
      function load() {
        const compiler = Compiler(assetsManager);
        const renderer = Renderer();
        const rootController = RootController();
        const component = Component(
          rootController,
          compiler.compile(window.frameEvents),
          ScreenObjectsManager(),
          renderer
        );
        component.play();
        console.debug(component);

        setInterval(function () {
          document.getElementById("frame").value = component.currentFrameCount;

          const vars = component.componentUserVariables;
          let text = "";
          Object.keys(vars).forEach(function (key) {
            text += key;
            text += "\t\t";
            text += vars[key];
            text += "\n";
          });
          document.getElementById("userVars").value = text;
        }, 300);
      }

      let firstEvent = true;
      window.addEventListener("message", function (e) {
        if (firstEvent) {
          const data = JSON.parse(e.data);
          window.assetsManager = AssetsManager(data["allIdToAsset"]);
          window.frameEvents = data["frameEvents"];
          load();
        }
        firstEvent = false;
      });
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      .variables {
      }
      .layout {
        display: flex;
      }
      .player_root {
        flex-shrink: 0;
      }
      .debugger {
        padding: 12px;
      }

      #userVars {
        width: 400px;
        height: 250px;
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <div id="root" class="player_root"></div>
      <div class="debugger">
        <div>フレーム: <input id="frame" type="text" /></div>

        <div>ユーザ変数</div>
        <textarea id="userVars"></textarea>
      </div>
    </div>
  </body>
</html>
